<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local Home Jobs | Lead Tracking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    input[type="date"], input[type="tel"], input[type="email"], input[type="text"], input[type="number"] { appearance: none; }
    /* Chips (submitters seleccionados) */
    .chip { @apply inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs border bg-gray-50; }
    .chip button { @apply text-gray-500 hover:text-red-600; }
    /* Inputs compactos */
    .compact { @apply w-full rounded-xl border border-gray-300 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500; }
    /* Grids breves */
    .kpi { @apply rounded-2xl border bg-white p-4; }
  </style>
</head>
<body class="min-h-screen bg-gray-50">
  <main class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold tracking-tight">Local Home Jobs | Lead Tracking</h1>
    </header>

    <!-- Login -->
    <section id="sectionLogin" class="bg-white rounded-2xl shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">Login</h2>
      <p class="text-sm text-gray-600 mb-3">Enter your email to continue:</p>
      <div class="flex gap-3">
        <input id="loginEmail" type="email" placeholder="youremail@company.com" class="compact" />
        <button id="btnLogin" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">Login</button>
      </div>
      <p id="loginMsg" class="text-xs text-red-600 mt-2 hidden">Invalid email</p>
    </section>

    <div id="tabsWrap" class="hidden">
      <div class="flex gap-2 mb-4">
        <button id="tabCapture" class="px-4 py-2 rounded-xl border border-indigo-200 bg-white">Capture</button>
        <button id="tabReports" class="px-4 py-2 rounded-xl border border-indigo-200 bg-white">Reports</button>
      </div>

      <!-- Capture -->
      <section id="sectionCapture" class="bg-white rounded-2xl shadow p-6">
        <form id="leadForm" class="grid grid-cols-1 gap-4" novalidate>
          <div class="flex items-center justify-between">
            <div class="text-sm text-gray-600">Registration date</div>
            <div id="todayTag" class="text-xs px-2 py-1 rounded-full bg-gray-100 border">—</div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" for="submitter_email">Your email</label>
            <input id="submitter_email" type="email" readonly class="compact bg-gray-100" />
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="client_name">Client name</label>
              <input id="client_name" type="text" required placeholder="John Doe" class="compact" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="company_name">Company</label>
              <input id="company_name" type="text" placeholder="Company XYZ" class="compact" />
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="phone">Phone</label>
              <input id="phone" type="tel" inputmode="numeric" maxlength="16" required placeholder="(333) 123-4567" class="compact" />
              <p class="text-xs text-gray-500 mt-1">Auto-format: (###) ###-#### — paste like <code>(386) 627-6554</code>.</p>
              <p id="phoneErr" class="text-xs text-red-600 mt-1 hidden">Enter at least 10 digits.</p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="response_type">Response type</label>
              <select id="response_type" required class="compact">
                <option value="">Select…</option>
                <option>Booked</option>
                <option>NA</option>
                <option>Not interested</option>
                <option>Call Back</option>
              </select>
            </div>
          </div>

          <div id="callback_wrap" class="hidden">
            <label class="block text-sm font-medium mb-1" for="callback_date">Call Back date</label>
            <input id="callback_date" type="date" class="compact" />
            <p class="text-xs text-gray-500 mt-1">Required only if you select "Call Back".</p>
          </div>

          <!-- Booked extras -->
          <div id="booked_extras" class="hidden border rounded-2xl p-4 bg-indigo-50/30">
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="closer">Closer</label>
                <select id="closer" class="compact"></select>
                <p class="text-xs text-gray-500 mt-1">Edit list in the code (CLOSERS array).</p>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="date_of_booking">Date of booking</label>
                <input id="date_of_booking" type="date" class="compact" />
              </div>
            </div>
            <div class="mt-4">
              <a href="https://api.estatelyconsulting.com/widget/booking/vHUVQH2FjmWoKuUJ1rXu?user_id=nJoyVpZO49NoNwPbI17V" target="_blank" rel="noopener"
                 class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border bg-white hover:bg-gray-50 underline">
                Booking Calendar
              </a>
              <p class="text-xs text-gray-600 mt-2">Remember to always use the "Daylight Savings time, ie: CST-CDT".</p>
            </div>
          </div>

          <!-- Sub account -->
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="sub_account">Sub account</label>
              <input id="sub_account" type="number" inputmode="numeric" min="1" max="999" placeholder="101" class="compact" />
              <p class="text-xs text-gray-500 mt-1">Only digits 1–999.</p>
              <p id="subAccErr" class="text-xs text-red-600 mt-1 hidden">Enter a number between 1 and 999.</p>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="source">Source (optional)</label>
              <input id="source" type="text" placeholder="BBB Roofers / Campaign X" class="compact" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="notes">Notes (optional)</label>
              <input id="notes" type="text" placeholder="Short comments" class="compact" />
            </div>
          </div>

          <div class="flex items-center justify-end gap-3 pt-2">
            <button id="resetBtn" type="button" class="px-4 py-2 rounded-xl border border-gray-300">Clear</button>
            <button id="submitBtn" type="button" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">Save</button>
            <button id="logoutBtn" type="button" class="px-4 py-2 rounded-xl border border-red-300 text-red-600">Log out</button>
          </div>
        </form>
        <div id="toast" class="hidden mt-4 rounded-2xl border p-3 text-sm"></div>
      </section>

      <!-- Reports + Analytics -->
      <section id="sectionReports" class="bg-white rounded-2xl shadow p-6 mt-6 hidden">
        <h2 class="text-xl font-semibold mb-4">Reports</h2>

        <div class="grid md:grid-cols-5 gap-4 mb-4 items-end">
          <input id="q_email" type="email" class="hidden" readonly />

          <!-- Submitters compacto (input + chips) -->
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Submitters (emails + legacy names)</label>
            <div class="flex gap-2">
              <input id="actorInput" list="actorsList" placeholder="Type email or name…" class="compact flex-1" />
              <button id="addActorBtn" class="px-3 py-2 rounded-xl border">Add</button>
            </div>
            <datalist id="actorsList"></datalist>
            <div class="flex flex-wrap gap-2 mt-2" id="actorsChips"></div>
            <div class="mt-2 flex gap-3 text-sm">
              <button id="addAllActorsBtn" class="underline text-indigo-700">Add all</button>
              <button id="clearActorsBtn" class="underline text-gray-600">Clear</button>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" for="q_start">From</label>
            <input id="q_start" type="date" class="compact" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="q_end">To</label>
            <input id="q_end" type="date" class="compact" />
          </div>
          <div class="flex items-center gap-3">
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="q_callbacks_only" type="checkbox" class="rounded" /> Call Backs only
            </label>
          </div>
        </div>

        <div class="flex gap-2 mb-4">
          <button id="btnQuery" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">Query</button>
          <button id="btnExport" class="px-4 py-2 rounded-xl border">Export CSV</button>
        </div>

        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left border-b bg-gray-50">
                <th class="py-2 pr-4">Date</th>
                <th class="py-2 pr-4">Email / Name</th>
                <th class="py-2 pr-4">Client</th>
                <th class="py-2 pr-4">Company</th>
                <th class="py-2 pr-4">Phone</th>
                <th class="py-2 pr-4">Response</th>
                <th class="py-2 pr-4">Callback</th>
                <th class="py-2 pr-4">Closer</th>
                <th class="py-2 pr-4">Date of booking</th>
                <th class="py-2 pr-4">Sub account</th>
                <th class="py-2 pr-4">Source</th>
                <th class="py-2 pr-4">Notes</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>

        <p id="resultsCount" class="text-xs text-gray-500 mt-3">—</p>

        <!-- Analytics -->
        <h3 class="text-lg font-semibold mt-8 mb-3">Analytics</h3>
        <div class="grid sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-4">
          <div class="kpi"><div class="text-xs text-gray-500">Total</div><div id="kpiTotal" class="text-xl font-semibold">0</div></div>
          <div class="kpi"><div class="text-xs text-gray-500">Booked</div><div id="kpiBooked" class="text-xl font-semibold">0</div></div>
          <div class="kpi"><div class="text-xs text-gray-500">NA</div><div id="kpiNA" class="text-xl font-semibold">0</div></div>
          <div class="kpi"><div class="text-xs text-gray-500">Not interested</div><div id="kpiNI" class="text-xl font-semibold">0</div></div>
          <div class="kpi"><div class="text-xs text-gray-500">Call Back</div><div id="kpiCB" class="text-xl font-semibold">0</div></div>
          <div class="kpi"><div class="text-xs text-gray-500">Conversion</div><div id="kpiConv" class="text-xl font-semibold">0%</div></div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <div class="kpi">
            <div class="text-sm font-medium mb-2">By response type</div>
            <canvas id="chartTypes" height="160"></canvas>
          </div>
          <div class="kpi">
            <div class="text-sm font-medium mb-2">By submitter (stacked)</div>
            <canvas id="chartSubmitters" height="160"></canvas>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // === Config ===
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzflGfquQ0T2sTHdmTnKOwpAClwKfc_hi9XtBH3dbIPqieuVZpKPE3HIIBlfXGB85fJ/exec";
    const API_KEY = "X9fj_82kjhPpLz!2025$Secure";
    const CLOSERS = ['Ryan Irvine','Jacob Donaldson','Anders Dahl','Marcos Flores','James McNamara','Oswaldo Hill'];

    let currentUserEmail = '';
    let allActors = [];          // emails + legacy names
    let selectedActors = [];     // chips
    let lastResults = [];

    // Login
    document.getElementById('btnLogin').addEventListener('click', () => {
      const email = document.getElementById('loginEmail').value.trim();
      if (!email || !(email.includes('@') && email.includes('.'))) {
        document.getElementById('loginMsg').classList.remove('hidden');
        return;
      }
      document.getElementById('loginMsg').classList.add('hidden');
      currentUserEmail = email;
      submitter_email.value = email;
      q_email.value = email;
      sectionLogin.classList.add('hidden');
      tabsWrap.classList.remove('hidden');
      loadActorsList();
    });

    // Tabs
    const tabCapture = document.getElementById('tabCapture');
    const tabReports = document.getElementById('tabReports');
    const sectionCapture = document.getElementById('sectionCapture');
    const sectionReports = document.getElementById('sectionReports');
    tabCapture.addEventListener('click', ()=>setTab('capture'));
    tabReports.addEventListener('click', ()=>setTab('reports'));
    function setTab(which){
      const active = (which==='capture'? tabCapture : tabReports);
      const inactive= (which==='capture'? tabReports : tabCapture);
      active.classList.add('bg-indigo-600','text-white');
      inactive.classList.remove('bg-indigo-600','text-white');
      sectionCapture.classList.toggle('hidden', which!=='capture');
      sectionReports.classList.toggle('hidden', which!=='reports');
      if (which==='reports') loadActorsList();
    }
    setTab('capture');

    todayTag.textContent = new Date().toLocaleDateString('en-US',{year:'numeric',month:'2-digit',day:'2-digit'});

    // Response toggles
    const responseSelect = document.getElementById('response_type');
    const callbackWrap = document.getElementById('callback_wrap');
    const callbackInput = document.getElementById('callback_date');
    const bookedExtras = document.getElementById('booked_extras');
    const closerSelect = document.getElementById('closer');
    const dateOfBooking = document.getElementById('date_of_booking');
    function renderClosers(){ closerSelect.innerHTML = '<option value="">Select…</option>'+CLOSERS.map(n=>`<option>${n}</option>`).join(''); }
    renderClosers();
    responseSelect.addEventListener('change', ()=>{
      const v=responseSelect.value;
      const isCallback = v==='Call Back';
      const isBooked  = v==='Booked';
      callbackWrap.classList.toggle('hidden', !isCallback);
      callbackInput.required = isCallback;
      bookedExtras.classList.toggle('hidden', !isBooked);
      if(!isCallback) callbackInput.value='';
    });

    // Phone formatting
    const phoneInput = document.getElementById('phone');
    const phoneErr = document.getElementById('phoneErr');
    function fmtUS(d){ d=d.slice(0,10); if(d.length<=3) return d?`(${d}`:''; if(d.length<=6) return `(${d.slice(0,3)}) ${d.slice(3)}`; return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`; }
    phoneInput.addEventListener('input', ()=>{ const digits=(phoneInput.value.match(/[0-9]/g)||[]).join(''); phoneInput.value=fmtUS(digits); phoneErr.classList.toggle('hidden', digits.length>=10); });
    phoneInput.addEventListener('blur', ()=>{ const digits=(phoneInput.value.match(/[0-9]/g)||[]).join(''); phoneErr.classList.toggle('hidden', digits.length>=10); });

    // Sub account validation
    const subAcc = document.getElementById('sub_account');
    const subAccErr = document.getElementById('subAccErr');
    subAcc.addEventListener('input', ()=>{
      const digits=(subAcc.value.match(/[0-9]/g)||[]).join('').slice(0,3);
      subAcc.value=digits;
      const n = digits? parseInt(digits,10):NaN;
      const ok = !digits || (n>=1 && n<=999);
      subAccErr.classList.toggle('hidden', ok);
    });

    // Toasts
    const toast = document.getElementById('toast');
    function showToast(msg,type='info'){
      toast.textContent=msg;
      toast.className='mt-4 rounded-2xl border p-3 text-sm';
      if(type==='success') toast.classList.add('bg-green-50','border-green-300','text-green-800');
      else if(type==='error') toast.classList.add('bg-red-50','border-red-300','text-red-800');
      else toast.classList.add('bg-white','border-gray-300','text-gray-800');
    }

    // Reset (mantiene email)
    resetBtn.addEventListener('click', ()=>{
      leadForm.reset(); callbackWrap.classList.add('hidden'); bookedExtras.classList.add('hidden');
      phoneErr.classList.add('hidden'); subAccErr.classList.add('hidden');
      if(currentUserEmail){ submitter_email.value=currentUserEmail; q_email.value=currentUserEmail; }
      showToast('Form cleared.','info');
    });

    // Save
    submitBtn.addEventListener('click', async ()=>{
      const email = submitter_email.value.trim();
      const digitsOnlyPhone = (phoneInput.value.match(/[0-9]/g)||[]).join('');
      const resp = responseSelect.value;
      const okEmail = email.includes('@') && email.includes('.');
      const subVal = (subAcc.value||'').trim();
      const subOk = !subVal || (/^\d{1,3}$/.test(subVal) && +subVal>=1 && +subVal<=999);
      if(!okEmail) return showToast('Enter a valid email.','error');
      if(!client_name.value.trim()) return showToast('Client name is required.','error');
      if(digitsOnlyPhone.length<10) return showToast('Phone must have at least 10 digits.','error');
      if(!resp) return showToast('Select a response type.','error');
      if(resp==='Call Back' && !callbackInput.value) return showToast('Select a Call Back date.','error');
      if(!subOk) return showToast('Sub account must be 1–999.','error');

      try{
        const form = new URLSearchParams({
          api_key: API_KEY, submitter_email: email,
          client_name: client_name.value.trim(), company_name: company_name.value.trim(),
          phone: digitsOnlyPhone, response_type: resp, callback_date: callbackInput.value || '',
          closer: (resp==='Booked'? (closer.value||'') : ''), date_of_booking: (resp==='Booked'? (dateOfBooking.value||'') : ''),
          sub_account: subVal || '', source: source.value.trim(), notes: notes.value.trim()
        });
        const res = await fetch(WEB_APP_URL,{ method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: form.toString() });
        const txt = await res.text(); let data; try{ data=JSON.parse(txt);}catch{ throw new Error('Bad JSON from backend: '+txt); }
        if(!data.success) throw new Error(data.message||'Save error');

        leadForm.reset(); callbackWrap.classList.add('hidden'); bookedExtras.classList.add('hidden');
        phoneErr.classList.add('hidden'); subAccErr.classList.add('hidden');
        if(currentUserEmail){ submitter_email.value=currentUserEmail; q_email.value=currentUserEmail; }
        showToast('Saved ✔️','success');
      }catch(err){ showToast('Save failed: '+err.message,'error'); console.error(err); }
    });

    // Logout
    logoutBtn.addEventListener('click', ()=>{
      currentUserEmail=''; leadForm.reset(); callbackWrap.classList.add('hidden'); bookedExtras.classList.add('hidden');
      phoneErr.classList.add('hidden'); subAccErr.classList.add('hidden');
      tabsWrap.classList.add('hidden'); sectionLogin.classList.remove('hidden');
      loginEmail.value=''; submitter_email.value=''; q_email.value='';
      resultsBody.innerHTML=''; resultsCount.textContent='—'; clearActors();
      destroyCharts(); resetKPIs();
      showToast('Logged out.','info');
    });

    // ===== Submitters (input + chips) =====
    const actorsList = document.getElementById('actorsList');
    const actorInput = document.getElementById('actorInput');
    const actorsChips= document.getElementById('actorsChips');
    document.getElementById('addActorBtn').addEventListener('click', (e)=>{ e.preventDefault(); addActor(actorInput.value.trim()); actorInput.value=''; });
    document.getElementById('addAllActorsBtn').addEventListener('click', (e)=>{ e.preventDefault(); allActors.forEach(a=>addActor(a)); });
    document.getElementById('clearActorsBtn').addEventListener('click', (e)=>{ e.preventDefault(); clearActors(); });

    function addActor(val){
      if(!val) return;
      if(!allActors.includes(val)) return; // sólo de la lista permitida
      if(selectedActors.includes(val)) return;
      selectedActors.push(val);
      renderChips();
    }
    function removeActor(val){
      selectedActors = selectedActors.filter(v=>v!==val);
      renderChips();
    }
    function clearActors(){ selectedActors=[]; renderChips(); }
    function renderChips(){
      actorsChips.innerHTML = selectedActors.map(v=>(
        `<span class="chip">${escapeHtml(v)} <button title="Remove" onclick="removeActor('${escapeAttr(v)}')">&times;</button></span>`
      )).join('');
    }
    window.removeActor = removeActor; // para los botones de los chips

    async function loadActorsList(){
      if(!currentUserEmail) return;
      try{
        const url = new URL(WEB_APP_URL);
        url.searchParams.set('api_key', API_KEY);
        url.searchParams.set('email', currentUserEmail);
        url.searchParams.set('list', 'actors'); // backend devuelve {emails, names}
        const res = await fetch(url.toString());
        const data = await res.json();
        if(!data.success) throw new Error(data.message || 'Failed to load submitters');
        const emails=(data.emails||[]), names=(data.names||[]);
        allActors = [...emails, ...names];
        actorsList.innerHTML = allActors.map(v=>`<option value="${escapeAttr(v)}">`).join('');
        // si no hay selección, por default ninguno; puedes usar addAllActorsBtn si quieres todos
      }catch(err){
        console.error(err); allActors=[]; actorsList.innerHTML='';
      }
    }

    // ===== Reports & Analytics =====
    const btnQuery = document.getElementById('btnQuery');
    const btnExport= document.getElementById('btnExport');
    const resultsBody = document.getElementById('resultsBody');
    const resultsCount= document.getElementById('resultsCount');

    btnQuery.addEventListener('click', async (e)=>{
      e.preventDefault();
      const actor = q_email.value.trim();
      if(!(actor.includes('@') && actor.includes('.'))) return alert('Login email missing.');
      const start = q_start.value; const end = q_end.value;
      const cbOnly = q_callbacks_only.checked ? '1' : '0';
      try{
        const url = new URL(WEB_APP_URL);
        url.searchParams.set('api_key', API_KEY);
        url.searchParams.set('email', actor);
        if(selectedActors.length) url.searchParams.set('actors', selectedActors.join(','));
        if(start) url.searchParams.set('start', start);
        if(end)   url.searchParams.set('end', end);
        url.searchParams.set('callbacks_only', cbOnly);
        const res = await fetch(url.toString());
        const data = await res.json();
        if(!data.success) throw new Error(data.message||'Query error');
        lastResults = data.rows || [];
        renderResults(lastResults);
        renderAnalytics(lastResults);
      }catch(err){
        alert('Query failed: '+err.message); console.error(err);
      }
    });

    function renderResults(rows){
      resultsBody.innerHTML='';
      for(const r of rows){
        const tr=document.createElement('tr'); tr.className='border-b';
        tr.innerHTML=`
          <td class="py-2 pr-4 whitespace-nowrap">${escapeHtml(r.timestamp)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.submitter_email)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.client_name)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.company_name)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.phone)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.response_type)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.callback_date)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.closer||'')}</td>
          <td class="py-2 pr-4">${escapeHtml(r.date_of_booking||'')}</td>
          <td class="py-2 pr-4">${escapeHtml(r.sub_account||'')}</td>
          <td class="py-2 pr-4">${escapeHtml(r.source)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.notes)}</td>`;
        resultsBody.appendChild(tr);
      }
      resultsCount.textContent = `${rows.length} result(s)`;
    }

    btnExport.addEventListener('click', ()=>{
      if(!lastResults.length) return alert('No results to export.');
      const headers = Object.keys(lastResults[0] || { timestamp:'', submitter_email:'', client_name:'', company_name:'', phone:'', response_type:'', callback_date:'', closer:'', date_of_booking:'', sub_account:'', source:'', notes:'' });
      const NL = String.fromCharCode(10);
      const csv = [headers.join(','), ...lastResults.map(r=>headers.map(h=>csvEscape(r[h] ?? '')).join(','))].join(NL);
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='tracking_report.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // === Analytics ===
    const kpiTotal = document.getElementById('kpiTotal');
    const kpiBooked= document.getElementById('kpiBooked');
    const kpiNA    = document.getElementById('kpiNA');
    const kpiNI    = document.getElementById('kpiNI');
    const kpiCB    = document.getElementById('kpiCB');
    const kpiConv  = document.getElementById('kpiConv');
    let chartTypes=null, chartSubmitters=null;

    function resetKPIs(){ kpiTotal.textContent=kpiBooked.textContent=kpiNA.textContent=kpiNI.textContent=kpiCB.textContent='0'; kpiConv.textContent='0%'; }
    function destroyCharts(){ if(chartTypes){ chartTypes.destroy(); chartTypes=null;} if(chartSubmitters){ chartSubmitters.destroy(); chartSubmitters=null;} }

    function renderAnalytics(rows){
      // KPIs
      const norm = s => String(s||'').toLowerCase().trim();
      const T = rows.length;
      const B = rows.filter(r=>norm(r.response_type)==='booked').length;
      const NA= rows.filter(r=>norm(r.response_type)==='na').length;
      const NI= rows.filter(r=>norm(r.response_type)==='not interested').length;
      const CB= rows.filter(r=>norm(r.response_type)==='call back').length;
      kpiTotal.textContent=T; kpiBooked.textContent=B; kpiNA.textContent=NA; kpiNI.textContent=NI; kpiCB.textContent=CB;
      kpiConv.textContent = T? Math.round((B/T)*100)+'%' : '0%';

      // Chart by type
      const ctx1=document.getElementById('chartTypes').getContext('2d');
      destroyCharts();
      chartTypes = new Chart(ctx1,{
        type:'bar',
        data:{ labels:['Booked','NA','Not interested','Call Back'], datasets:[{ label:'Count', data:[B,NA,NI,CB] }] },
        options:{ responsive:true, plugins:{ legend:{display:false}}, scales:{ y:{ beginAtZero:true, precision:0 } } }
      });

      // Stacked by submitter
      const submitters = Array.from(new Set(rows.map(r=>r.submitter_email||''))).sort((a,b)=>a.localeCompare(b));
      const types=['Booked','NA','Not interested','Call Back'];
      const dataBySub = submitters.map(s=>{
        const items = rows.filter(r=> (r.submitter_email||'')===s);
        return {
          Booked: items.filter(r=>norm(r.response_type)==='booked').length,
          NA:     items.filter(r=>norm(r.response_type)==='na').length,
          NI:     items.filter(r=>norm(r.response_type)==='not interested').length,
          CB:     items.filter(r=>norm(r.response_type)==='call back').length
        };
      });
      const ds = [
        {label:'Booked',        data:dataBySub.map(x=>x.Booked), stack:'stack1'},
        {label:'NA',            data:dataBySub.map(x=>x.NA),     stack:'stack1'},
        {label:'Not interested',data:dataBySub.map(x=>x.NI),     stack:'stack1'},
        {label:'Call Back',     data:dataBySub.map(x=>x.CB),     stack:'stack1'}
      ];
      const ctx2=document.getElementById('chartSubmitters').getContext('2d');
      chartSubmitters = new Chart(ctx2,{
        type:'bar',
        data:{ labels: submitters, datasets: ds },
        options:{ responsive:true, plugins:{ legend:{ position:'top' }}, scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true, precision:0 } } }
      });
    }

    // Utils
    function csvEscape(v){ const s=String(v).replaceAll('"','""'); return /[",\n]/.test(s)? `"${s}"`: s; }
    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function escapeAttr(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

    // Hotkeys: enter en actorInput agrega
    actorInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); addActor(actorInput.value.trim()); actorInput.value=''; }});
  </script>
</body>
</html>
