<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local Home Jobs | Lead Tracking</title>
  <script src="https://cdn.tailwindcss.com"></script>
 <style>
  input[type="date"], input[type="tel"], input[type="email"], input[type="text"], input[type="number"] { appearance: none; }

/* Caja compacta solo para el selector de submitters */
  #q_emails {
    height: 8rem;       /* altura fija */
    min-height: 0;      /* ignora mínimos anteriores */
    overflow-y: auto;   /* scroll vertical si hay muchos */
  }
</style>

</head>
<body class="min-h-screen bg-gray-50">
  <main class="max-w-5xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold tracking-tight">Local Home Jobs | Lead Tracking</h1>
    </header>

    <!-- Login -->
    <section id="sectionLogin" class="bg-white rounded-2xl shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">Login</h2>
      <p class="text-sm text-gray-600 mb-3">Enter your email to continue:</p>
      <div class="flex gap-3">
        <input id="loginEmail" type="email" placeholder="youremail@company.com" class="flex-1 rounded-xl border border-gray-300 px-3 py-2" />
        <button id="btnLogin" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">Login</button>
      </div>
      <p id="loginMsg" class="text-xs text-red-600 mt-2 hidden">Invalid or not allowed email</p>
    </section>

    <div id="tabsWrap" class="hidden">
      <div class="flex gap-2 mb-4">
        <button id="tabCapture" class="px-4 py-2 rounded-xl border border-indigo-200 bg-white">Capture</button>
        <button id="tabReports" class="px-4 py-2 rounded-xl border border-indigo-200 bg-white">Reports</button>
      </div>

      <!-- Capture -->
      <section id="sectionCapture" class="bg-white rounded-2xl shadow p-6">
        <form id="leadForm" class="grid grid-cols-1 gap-4" novalidate>
          <div class="flex items-center justify-between">
            <div class="text-sm text-gray-600">Registration date</div>
            <div id="todayTag" class="text-xs px-2 py-1 rounded-full bg-gray-100 border">—</div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" for="submitter_email">Your email</label>
            <input id="submitter_email" name="submitter_email" type="email" readonly
                   class="w-full rounded-xl border border-gray-300 px-3 py-2 bg-gray-100" />
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="client_name">Client name</label>
              <input id="client_name" name="client_name" type="text" required placeholder="John Doe"
                     class="w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="company_name">Company</label>
              <input id="company_name" name="company_name" type="text" placeholder="Company XYZ"
                     class="w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="phone">Phone</label>
              <input id="phone" name="phone" type="tel" inputmode="numeric" maxlength="16" required placeholder="(333) 123-4567"
                     class="w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
              <p class="text-xs text-gray-500 mt-1">Auto-format: (###) ###-#### — paste like <code>(386) 627-6554</code>.</p>
              <p id="phoneErr" class="text-xs text-red-600 mt-1 hidden">Enter at least 10 digits.</p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="response_type">Response type</label>
              <select id="response_type" name="response_type" required
                      class="w-full rounded-xl border border-gray-300 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">Select…</option>
                <option>Booked</option>
                <option>NA</option>
                <option>Not interested</option>
                <option>Call Back</option>
              </select>
            </div>
          </div>

          <div id="callback_wrap" class="hidden">
            <label class="block text-sm font-medium mb-1" for="callback_date">Call Back date</label>
            <input id="callback_date" name="callback_date" type="date"
                   class="w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            <p class="text-xs text-gray-500 mt-1">Required only if you select "Call Back".</p>
          </div>

          <div id="booked_extras" class="hidden border rounded-xl p-4 bg-indigo-50/30">
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="closer">Closer</label>
                <select id="closer" name="closer"
                        class="w-full rounded-xl border border-gray-300 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
                <p class="text-xs text-gray-500 mt-1">Edit list in the code (CLOSERS array).</p>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="date_of_booking">Date of booking</label>
                <input id="date_of_booking" name="date_of_booking" type="date"
                       class="w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
              </div>
            </div>
            <div class="mt-4">
              <a href="https://api.estatelyconsulting.com/widget/booking/vHUVQH2FjmWoKuUJ1rXu?user_id=nJoyVpZO49NoNwPbI17V" target="_blank" rel="noopener"
                 class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border bg-white hover:bg-gray-50 underline">
                Booking Calendar
              </a>
              <p class="text-xs text-gray-600 mt-2">Remember to always use the "Daylight Savings time, ie: CST-CDT".</p>
            </div>
          </div>

          <!-- Sub account -->
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="sub_account">Sub account</label>
              <input id="sub_account" name="sub_account" type="number" inputmode="numeric" min="1" max="999" placeholder="101"
                     class="w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
              <p class="text-xs text-gray-500 mt-1">Only digits 1–999.</p>
              <p id="subAccErr" class="text-xs text-red-600 mt-1 hidden">Enter a number between 1 and 999.</p>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="source">Source (optional)</label>
              <input id="source" name="source" type="text" placeholder="BBB Roofers / Campaign X"
                     class="w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="notes">Notes (optional)</label>
              <input id="notes" name="notes" type="text" placeholder="Short comments"
                     class="w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            </div>
          </div>

          <div class="flex items-center justify-end gap-3 pt-2">
            <button id="resetBtn" type="button" class="px-4 py-2 rounded-xl border border-gray-300">Clear</button>
            <button id="submitBtn" type="button" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">Save</button>
            <button id="logoutBtn" type="button" class="px-4 py-2 rounded-xl border border-red-300 text-red-600">Log out</button>
          </div>
        </form>
        <div id="toast" class="hidden mt-4 rounded-xl border p-3 text-sm"></div>
      </section>

      <!-- Reports -->
      <section id="sectionReports" class="bg-white rounded-2xl shadow p-6 mt-6 hidden">
        <h2 class="text-xl font-semibold mb-4">Reports</h2>
        <div class="grid md:grid-cols-5 gap-4 mb-4 items-end">
          <input id="q_email" type="email" class="hidden" readonly />
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1" for="q_actors">Submitters (emails + legacy names)</label>
            <select id="q_actors" multiple size="8"
                    class="w-full h-32 rounded-xl border border-gray-300 px-3 py-2 bg-white overflow-y-auto"></select>
            <label class="inline-flex items-center gap-2 text-sm mt-2">
              <input id="q_select_all" type="checkbox" class="rounded" /> Select all
            </label>
            <p id="actorsMsg" class="text-xs text-amber-700 mt-1 hidden">No submitters found yet.</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="q_start">From</label>
            <input id="q_start" type="date" class="w-full rounded-xl border border-gray-300 px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="q_end">To</label>
            <input id="q_end" type="date" class="w-full rounded-xl border border-gray-300 px-3 py-2" />
          </div>
          <div class="flex items-center gap-3">
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="q_callbacks_only" type="checkbox" class="rounded" /> Call Backs only
            </label>
          </div>
        </div>

        <div class="flex gap-2 mb-4">
          <button id="btnQuery" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">Query</button>
          <button id="btnExport" class="px-4 py-2 rounded-xl border">Export CSV</button>
        </div>

        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left border-b bg-gray-50">
                <th class="py-2 pr-4">Date</th>
                <th class="py-2 pr-4">Email / Name</th>
                <th class="py-2 pr-4">Client</th>
                <th class="py-2 pr-4">Company</th>
                <th class="py-2 pr-4">Phone</th>
                <th class="py-2 pr-4">Response</th>
                <th class="py-2 pr-4">Callback</th>
                <th class="py-2 pr-4">Closer</th>
                <th class="py-2 pr-4">Date of booking</th>
                <th class="py-2 pr-4">Sub account</th>
                <th class="py-2 pr-4">Source</th>
                <th class="py-2 pr-4">Notes</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>

        <p id="resultsCount" class="text-xs text-gray-500 mt-3">—</p>
      </section>
    </div>
  </main>

  <script>
    // === Config ===
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzflGfquQ0T2sTHdmTnKOwpAClwKfc_hi9XtBH3dbIPqieuVZpKPE3HIIBlfXGB85fJ/exec";
    const API_KEY = "X9fj_82kjhPpLz!2025$Secure";
    const CLOSERS = ['Ryan Irvine','Jacob Donaldson','Anders Dahl','Marcos Flores','James McNamara','Oswaldo Hill'];
    let currentUserEmail = '';

    // Login
    document.getElementById('btnLogin').addEventListener('click', () => {
      const email = document.getElementById('loginEmail').value.trim();
      if (!email || !(email.includes('@') && email.includes('.'))) {
        document.getElementById('loginMsg').classList.remove('hidden'); return;
      }
      document.getElementById('loginMsg').classList.add('hidden');
      currentUserEmail = email;
      document.getElementById('submitter_email').value = email;
      document.getElementById('q_email').value = email;
      document.getElementById('sectionLogin').classList.add('hidden');
      document.getElementById('tabsWrap').classList.remove('hidden');
      loadActorsList();
    });

    // Tabs
    const tabCapture = document.getElementById('tabCapture');
    const tabReports = document.getElementById('tabReports');
    const sectionCapture = document.getElementById('sectionCapture');
    const sectionReports = document.getElementById('sectionReports');
    function setTab(which){
      const active = which==='capture'? tabCapture : tabReports;
      const inactive= which==='capture'? tabReports : tabCapture;
      active.classList.add('bg-indigo-600','text-white');
      inactive.classList.remove('bg-indigo-600','text-white');
      sectionCapture.classList.toggle('hidden', which!=='capture');
      sectionReports.classList.toggle('hidden', which!=='reports');
      if (which==='reports') loadActorsList();
    }
    tabCapture.addEventListener('click',()=>setTab('capture'));
    tabReports.addEventListener('click',()=>setTab('reports'));
    setTab('capture');

    // Today
    document.getElementById('todayTag').textContent =
      new Date().toLocaleDateString('en-US', {year:'numeric',month:'2-digit',day:'2-digit'});

    // Response toggles + closers
    const responseSelect=document.getElementById('response_type');
    const callbackWrap=document.getElementById('callback_wrap');
    const callbackInput=document.getElementById('callback_date');
    const bookedExtras=document.getElementById('booked_extras');
    const closerSelect=document.getElementById('closer');
    const dateOfBooking=document.getElementById('date_of_booking');
    closerSelect.innerHTML = '<option value="">Select…</option>' + CLOSERS.map(n=>`<option>${n}</option>`).join('');
    responseSelect.addEventListener('change',()=>{
      const v=responseSelect.value;
      const isCallback = v==='Call Back';
      const isBooked   = v==='Booked';
      callbackWrap.classList.toggle('hidden', !isCallback);
      callbackInput.required = isCallback;
      bookedExtras.classList.toggle('hidden', !isBooked);
      if(!isCallback) callbackInput.value='';
    });

    // Phone mask
    const phoneInput=document.getElementById('phone');
    const phoneErr=document.getElementById('phoneErr');
    function formatUS(d){ const x=d.slice(0,10); if(x.length<=3) return x?`(${x}`:''; if(x.length<=6) return `(${x.slice(0,3)}) ${x.slice(3)}`; return `(${x.slice(0,3)}) ${x.slice(3,6)}-${x.slice(6)}`; }
    phoneInput.addEventListener('input',()=>{ const digits=(phoneInput.value.match(/[0-9]/g)||[]).join(''); phoneInput.value=formatUS(digits); phoneErr.classList.toggle('hidden', digits.length<10); });
    phoneInput.addEventListener('blur', ()=>{ const digits=(phoneInput.value.match(/[0-9]/g)||[]).join(''); phoneErr.classList.toggle('hidden', digits.length>=10); });

    // Sub account validation
    const subAcc=document.getElementById('sub_account'), subAccErr=document.getElementById('subAccErr');
    subAcc.addEventListener('input',()=>{ const digits=(subAcc.value.match(/[0-9]/g)||[]).join('').slice(0,3); subAcc.value=digits; const n=digits?parseInt(digits,10):NaN; subAccErr.classList.toggle('hidden', !digits || (n>=1&&n<=999)); });

    // Toasts
    const toast=document.getElementById('toast');
    function showToast(msg,type='info'){
      toast.textContent=msg;
      toast.className='mt-4 rounded-xl border p-3 text-sm';
      if(type==='success') toast.classList.add('bg-green-50','border-green-300','text-green-800');
      else if(type==='error') toast.classList.add('bg-red-50','border-red-300','text-red-800');
      else toast.classList.add('bg-white','border-gray-300','text-gray-800');
    }

    // Reset (mantiene email)
    document.getElementById('resetBtn').addEventListener('click',()=>{
      document.getElementById('leadForm').reset();
      callbackWrap.classList.add('hidden'); bookedExtras.classList.add('hidden');
      phoneErr.classList.add('hidden'); subAccErr.classList.add('hidden');
      if(currentUserEmail){ document.getElementById('submitter_email').value=currentUserEmail; document.getElementById('q_email').value=currentUserEmail; }
      showToast('Form cleared.','info');
    });

    // Save
    document.getElementById('submitBtn').addEventListener('click',async ()=>{
      const email=document.getElementById('submitter_email').value.trim();
      const digitsOnlyPhone=(phoneInput.value.match(/[0-9]/g)||[]).join('');
      const resp=responseSelect.value;
      const subVal=(document.getElementById('sub_account').value||'').trim();
      const okEmail=email.includes('@')&&email.includes('.');
      const subOk=!subVal || (/^\d{1,3}$/.test(subVal)&&parseInt(subVal,10)>=1&&parseInt(subVal,10)<=999);

      if(!okEmail) return showToast('Enter a valid email.','error');
      if(!document.getElementById('client_name').value.trim()) return showToast('Client name is required.','error');
      if(digitsOnlyPhone.length<10) return showToast('Phone must have at least 10 digits.','error');
      if(!resp) return showToast('Select a response type.','error');
      if(resp==='Call Back' && !document.getElementById('callback_date').value) return showToast('Select a Call Back date.','error');
      if(!subOk) return showToast('Sub account must be 1–999.','error');

      try{
        const form=new URLSearchParams({
          api_key:API_KEY, submitter_email:email,
          client_name:document.getElementById('client_name').value.trim(),
          company_name:document.getElementById('company_name').value.trim(),
          phone:digitsOnlyPhone, response_type:resp,
          callback_date:document.getElementById('callback_date').value||'',
          closer:(resp==='Booked' ? (document.getElementById('closer').value||'') : ''),
          date_of_booking:(resp==='Booked' ? (document.getElementById('date_of_booking').value||'') : ''),
          sub_account:subVal||'', source:document.getElementById('source').value.trim(),
          notes:document.getElementById('notes').value.trim(),
        });
        const res=await fetch(WEB_APP_URL,{ method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body:form.toString() });
        const txt=await res.text(); let data; try{ data=JSON.parse(txt); }catch{ throw new Error('Bad JSON from backend: '+txt); }
        if(!data.success) throw new Error(data.message||'Save error');

        document.getElementById('leadForm').reset();
        callbackWrap.classList.add('hidden'); bookedExtras.classList.add('hidden');
        phoneErr.classList.add('hidden'); subAccErr.classList.add('hidden');
        if(currentUserEmail){ document.getElementById('submitter_email').value=currentUserEmail; document.getElementById('q_email').value=currentUserEmail; }
        showToast('Saved ✔️','success');
      }catch(err){ showToast('Save failed: '+err.message,'error'); console.error(err); }
    });

    // Reports
    const qActors=document.getElementById('q_actors'), qSelectAll=document.getElementById('q_select_all'), actorsMsg=document.getElementById('actorsMsg');
    function optionsSelected(sel){ return Array.from(sel.options).filter(o=>o.selected).map(o=>o.value); }
    qSelectAll.addEventListener('change',()=>{ const all=qSelectAll.checked; Array.from(qActors.options).forEach(o=>o.selected=all); });

    async function loadActorsList(){
      if(!currentUserEmail) return;
      try{
        const url=new URL(WEB_APP_URL);
        url.searchParams.set('api_key',API_KEY);
        url.searchParams.set('email',currentUserEmail);
        url.searchParams.set('list','actors');
        const res=await fetch(url.toString());
        const data=await res.json();
        if(!data.success) throw new Error(data.message||'Failed to load actors');

        const emails=(data.emails||[]).sort((a,b)=>a.localeCompare(b));
        const names =(data.names ||[]).sort((a,b)=>a.localeCompare(b));

        const prev=new Set(optionsSelected(qActors));
        let html='';
        if(emails.length){ html+=`<optgroup label="Emails">`+emails.map(e=>`<option value="${e}">${e}</option>`).join('')+`</optgroup>`; }
        if(names.length){  html+=`<optgroup label="Legacy names">`+names.map(n=>`<option value="${n}">${n}</option>`).join('')+`</optgroup>`; }

        qActors.innerHTML = html || '';
        actorsMsg.classList.toggle('hidden', !!html);

        // restaurar selección previa
        Array.from(qActors.options).forEach(o=>{ if(prev.has(o.value)) o.selected=true; });
      }catch(err){
        console.error(err);
        qActors.innerHTML=''; actorsMsg.textContent='Could not load submitters.'; actorsMsg.classList.remove('hidden');
      }
    }

    let lastResults=[];
    document.getElementById('btnQuery').addEventListener('click', async (e)=>{
      e.preventDefault();
      const actor=document.getElementById('q_email').value.trim();
      if(!(actor.includes('@')&&actor.includes('.'))) return alert('Login email missing.');
      const selected=optionsSelected(qActors);
      const start=document.getElementById('q_start').value;
      const end  =document.getElementById('q_end').value;
      const cbOnly=document.getElementById('q_callbacks_only').checked?'1':'0';
      try{
        const url=new URL(WEB_APP_URL);
        url.searchParams.set('api_key',API_KEY);
        url.searchParams.set('email',actor);
        if(selected.length) url.searchParams.set('actors',selected.join(','));
        if(start) url.searchParams.set('start',start);
        if(end)   url.searchParams.set('end',end);
        url.searchParams.set('callbacks_only',cbOnly);
        const res=await fetch(url.toString());
        const data=await res.json();
        if(!data.success) throw new Error(data.message||'Query error');
        lastResults=data.rows||[];
        renderResults(lastResults);
      }catch(err){ alert('Query failed: '+err.message); console.error(err); }
    });

    function renderResults(rows){
      const tbody=document.getElementById('resultsBody'); tbody.innerHTML='';
      for(const r of rows){
        const tr=document.createElement('tr'); tr.className='border-b';
        tr.innerHTML=`
          <td class="py-2 pr-4 whitespace-nowrap">${escapeHtml(r.timestamp)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.submitter_email)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.client_name)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.company_name)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.phone)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.response_type)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.callback_date)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.closer||'')}</td>
          <td class="py-2 pr-4">${escapeHtml(r.date_of_booking||'')}</td>
          <td class="py-2 pr-4">${escapeHtml(r.sub_account||'')}</td>
          <td class="py-2 pr-4">${escapeHtml(r.source)}</td>
          <td class="py-2 pr-4">${escapeHtml(r.notes)}</td>`;
        tbody.appendChild(tr);
      }
      document.getElementById('resultsCount').textContent=`${rows.length} result(s)`;
    }

    document.getElementById('btnExport').addEventListener('click',()=>{
      if(!lastResults.length) return alert('No results to export.');
      const headers=Object.keys(lastResults[0]||{timestamp:'',submitter_email:'',client_name:'',company_name:'',phone:'',response_type:'',callback_date:'',closer:'',date_of_booking:'',sub_account:'',source:'',notes:''});
      const csv=[headers.join(','), ...lastResults.map(r=>headers.map(h=>csvEscape(r[h]??'')).join(','))].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='tracking_report.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    function csvEscape(v){ const s=String(v).replaceAll('"','""'); return /[",\n]/.test(s)?`"${s}"`:s; }
    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click',()=>{
      currentUserEmail=''; document.getElementById('leadForm').reset();
      callbackWrap.classList.add('hidden'); bookedExtras.classList.add('hidden');
      phoneErr.classList.add('hidden'); subAccErr.classList.add('hidden');
      document.getElementById('tabsWrap').classList.add('hidden');
      document.getElementById('sectionLogin').classList.remove('hidden');
      document.getElementById('loginEmail').value=''; document.getElementById('submitter_email').value=''; document.getElementById('q_email').value='';
      document.getElementById('resultsBody').innerHTML=''; document.getElementById('resultsCount').textContent='—'; qActors.innerHTML=''; actorsMsg.classList.add('hidden');
      showToast('Logged out.','info');
    });
  </script>
</body>
</html>
